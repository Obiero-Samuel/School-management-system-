{% extends "base.html" %}
{% block title %}Marks & Results{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar p-0">
            <div class="list-group list-group-flush">
                <a href="{{ url_for('teacher_dashboard') }}" class="nav-link"><i class="bi bi-speedometer2"></i> Dashboard</a>
                <a href="{{ url_for('staff_profile') }}" class="nav-link"><i class="bi bi-person"></i> Profile</a>
                <a href="{{ url_for('teacher_attendance') }}" class="nav-link"><i class="bi bi-calendar-check"></i> Attendance</a>
                <a href="{{ url_for('teacher_assignments') }}" class="nav-link"><i class="bi bi-clipboard"></i> Assignments</a>
                <a href="{{ url_for('teacher_marks') }}" class="nav-link active"><i class="bi bi-award"></i> Marks/Results</a>
            </div>
        </div>
        <div class="col-md-10 content-wrapper">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}
            {% endwith %}
            <div class="d-flex justify-content-between align-items-center mb-4"><h2><i class="bi bi-award"></i> Marks & Results</h2><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#marksModal"><i class="bi bi-plus-circle"></i> Add Marks</button></div>
            <div class="card"><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Student</th><th>Adm. No.</th><th>Class</th><th>Subject</th><th>Type</th><th>Marks</th><th>Term</th><th>Action</th></tr></thead><tbody>{% for mark in marks_records %}<tr><td>{{ mark.first_name }} {{ mark.last_name }}</td><td>{{ mark.admission_number }}</td><td>{{ mark.class_name }}</td><td>{{ mark.subject }}</td><td><span class="badge bg-info">{{ mark.exam_type }}</span></td><td>{{ mark.marks_obtained }}/{{ mark.total_marks }}</td><td>{{ mark.term }}</td><td><form method="POST" action="{{ url_for('send_results') }}" style="display:inline;"><input type="hidden" name="student_id" value="{{ mark.student_id }}"><button type="submit" class="btn btn-sm btn-success"><i class="bi bi-envelope"></i> Send to Parent</button></form></td></tr>{% endfor %}</tbody></table></div></div></div>
        </div>
    </div>
</div>
<div class="modal fade" id="marksModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-clipboard-plus"></i> Add Marks</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <form method="POST"><div class="modal-body">
            <div class="row"><div class="col-md-6 mb-3"><label class="form-label">Class *</label><select class="form-select" name="class_id" id="marksClassSelect" required onchange="loadMarksStudents()"><option value="">Select Class</option>{% for class in my_classes %}<option value="{{ class.id }}">{{ class.name }}</option>{% endfor %}</select></div>
            <div class="col-md-6 mb-3"><label class="form-label">Student *</label><select class="form-select" name="student_id" id="marksStudentSelect" required><option value="">Select Student</option></select></div></div>
            <div class="row"><div class="col-md-6 mb-3"><label class="form-label">Subject *</label><input type="text" class="form-control" name="subject" required></div>
            <div class="col-md-6 mb-3"><label class="form-label">Exam Type *</label><select class="form-select" name="exam_type" required><option value="">Select Type</option><option value="CAT">CAT</option><option value="Mid-Term">Mid-Term</option><option value="End-Term">End-Term</option><option value="Assignment">Assignment</option></select></div></div>
            <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Marks Obtained *</label><input type="number" step="0.01" class="form-control" name="marks_obtained" required placeholder="Enter marks obtained" title="Marks Obtained"></div>
            <div class="col-md-4 mb-3"><label class="form-label">Total Marks *</label><input type="number" step="0.01" class="form-control" name="total_marks" value="100" required placeholder="Enter total marks" title="Total Marks"></div>
            <div class="col-md-4 mb-3"><label class="form-label">Term *</label><input type="text" class="form-control" name="term" placeholder="e.g. Term 1" required></div></div>
            <div class="row"><div class="col-md-6 mb-3"><label class="form-label">Academic Year *</label><input type="text" class="form-control" name="academic_year" value="2026" required placeholder="Enter academic year" title="Academic Year"></div></div>
            <div class="mb-3">
                <label class="form-label" for="remarksTextarea">Remarks</label>
                <textarea class="form-control" name="remarks" id="remarksTextarea" rows="2" placeholder="Enter remarks"></textarea>
            </div>
        </div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Save Marks</button></div></form>
    </div></div>
</div>
<script>
function loadMarksStudents() {
    const classId = document.getElementById('marksClassSelect').value;
    if (!classId) return;
    fetch('/teacher/get-students/' + classId).then(r => r.json()).then(students => {
        const select = document.getElementById('marksStudentSelect');
        select.innerHTML = '<option value="">Select Student</option>';
        students.forEach(s => {
            select.innerHTML += `<option value="${s.id}">${s.first_name} ${s.last_name} (${s.admission_number})</option>`;
        });
    });
}
</script>
{% endblock %}
