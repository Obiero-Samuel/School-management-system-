{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Assignment Submissions: {{ assignment.title }}</h2>
  <h5>Class: {{ assignment.class_name }}</h5>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Student</th>
        <th>Parent</th>
        <th>Status</th>
        <th>File</th>
        <th>Grade</th>
        <th>Feedback</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for sub in submissions %}
      <tr>
        <td>{{ sub.student_first }} {{ sub.student_last }}</td>
        <td>{{ sub.parent_first }} {{ sub.parent_last }}</td>
        <td>{{ sub.status }}</td>
        <td>
          {% if sub.file_path %}
          <a href="{{ url_for('download_assignment_file', submission_id=sub.id) }}">Download</a>
          {% else %}-{% endif %}
        </td>
        <td>{% if sub.marks_obtained is not none %}{{ sub.marks_obtained }}/{{ sub.total_marks }}{% else %}-{% endif %}</td>
        <td>{{ sub.teacher_feedback or '-' }}</td>
        <td>
          {% if sub.status != 'Graded' %}
          <form action="{{ url_for('grade_submission') }}" method="post" class="d-inline">
            <input type="hidden" name="submission_id" value="{{ sub.id }}">
            <input type="number" name="marks_obtained" placeholder="Marks" min="0" max="{{ assignment.max_marks }}" required class="form-control form-control-sm mb-1">
            <input type="number" name="total_marks" value="{{ assignment.max_marks }}" min="1" max="{{ assignment.max_marks }}" required class="form-control form-control-sm mb-1">
            <input type="text" name="teacher_feedback" placeholder="Feedback" class="form-control form-control-sm mb-1">
            <button type="submit" class="btn btn-success btn-sm">Grade</button>
          </form>
          {% else %}-{% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <h4>Students Who Haven't Submitted</h4>
  <ul class="list-group mb-4">
    {% for student in not_submitted %}
    <li class="list-group-item">{{ student.first_name }} {{ student.last_name }}</li>
    {% else %}
    <li class="list-group-item">All students have submitted.</li>
    {% endfor %}
  </ul>
  <h4>Assignment Reviews</h4>
  <ul class="list-group">
    {% for review in reviews %}
    <li class="list-group-item">
      <strong>{{ review.user_type|capitalize }}:</strong> {{ review.review_text }}
      <span class="text-muted">({{ review.created_at }})</span>
      {% if review.rating %}<span class="badge bg-info">Rating: {{ review.rating }}</span>{% endif %}
    </li>
    {% else %}
    <li class="list-group-item">No reviews yet.</li>
    {% endfor %}
  </ul>
  <hr>
  <form action="{{ url_for('add_teacher_review') }}" method="post">
    <input type="hidden" name="assignment_id" value="{{ assignment.id }}">
    <div class="mb-3">
      <label for="student_id" class="form-label">Student</label>
      <select name="student_id" id="student_id" class="form-select" required>
        {% for sub in submissions %}
        <option value="{{ sub.student_id }}">{{ sub.student_first }} {{ sub.student_last }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label for="review_text" class="form-label">Review</label>
      <textarea class="form-control" name="review_text" id="review_text" required></textarea>
    </div>
    <div class="mb-3">
      <label for="rating" class="form-label">Rating (optional)</label>
      <input type="number" class="form-control" name="rating" id="rating" min="1" max="5">
    </div>
    <button type="submit" class="btn btn-primary">Add Review</button>
  </form>
</div>
{% endblock %}