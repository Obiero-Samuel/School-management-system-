<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>St. Monica's Student Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root { --grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --deep: #4b307b; }
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; margin: 0; min-height: 100vh; scroll-behavior: smooth; }
        .top-nav { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .sub-nav { background: white; border-bottom: 4px solid #764ba2; display: flex; justify-content: center; gap: 20px; padding: 10px 0; position: sticky; top: 0; z-index: 1000; }
        .nav-link { color: #555; font-weight: 600; padding: 10px 20px; border-radius: 20px; cursor: pointer; text-decoration: none; transition: 0.3s; }
        .nav-link.active { background: var(--grad); color: white !important; }
        .hero-section { background: var(--grad); color: white; padding: 60px 20px; text-align: center; }
        .image-container { width: 100%; max-width: 900px; height: 350px; margin: 30px auto; background: rgba(255,255,255,0.2); border: 2px dashed #fff; border-radius: 15px; display: flex; align-items: center; justify-content: center; }
        #authSection { display: none; padding: 40px 0; }
        .auth-card { max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .alert-box { display: none; padding: 15px; margin-bottom: 20px; border-radius: 5px; text-align: center; font-weight: bold; }
        .alert-box.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-box.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-box.info { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; }
    </style>
</head>
<body>

    <header class="top-nav"><h2>ST. MONICAH'S PORTAL</h2></header>

    <nav class="sub-nav shadow-sm">
        <a class="nav-link active" id="link-home" onclick="showHome()">Home</a>
        <a class="nav-link" id="link-admin" onclick="prepAuth('admin')">Admin</a>
        <a class="nav-link" id="link-staff" onclick="prepAuth('staff')">Staff</a>
        <a class="nav-link" id="link-parent" onclick="prepAuth('parent')">Parent</a>
    </nav>

    <section id="homeSection">
        <div class="hero-section">
            <h1 class="display-4 fw-bold">Welcome to St. Monicah's School</h1>
            <p class="lead">Select your portal from the navigation bar above to get started.</p>
        </div>
        <div class="container">
            <div class="image-container">
                <i class="bi bi-images" style="font-size: 3rem; color: white;"></i>
                <span class="ms-3 text-white">Campus Gallery Placeholder</span>
            </div>
        </div>
    </section>

    <main id="authSection" class="container">
        <div class="auth-card">
            <div id="globalSuccess" class="alert-box success">Email Verified Successfully! Please Login.</div>

            <div id="loginView">
                <h3 class="text-center mb-4" id="portalTitle">Login</h3>
                <div id="loginAlert" class="alert-box"></div>
                <div id="loginFormContent">
                    <div id="loginInputs"></div>
                    <button class="btn btn-primary w-100 mb-3" onclick="handleLogin()">Sign In</button>
                    <div id="regHint" class="text-center"><small>Need an account? <a href="#" onclick="showRegister()">Register</a></small></div>
                </div>
                <div id="loginOtpForm" style="display:none;">
                    <div class="alert alert-info">Enter the 6-digit code sent to your email.</div>
                    <input type="text" id="loginOtpInput" class="form-control mb-3 text-center" placeholder="000000" style="letter-spacing: 5px; font-size: 1.5rem;">
                    <button class="btn btn-warning w-100" onclick="handleLoginOtp()">Verify & Login</button>
                </div>
            </div>

            <div id="registerView" style="display:none;">
                <h3 class="text-center mb-4">Register</h3>
                <div id="registerAlert" class="alert-box"></div>
                <div id="registerContent">
                    <input type="text" id="regUser" class="form-control mb-3" placeholder="Username">
                    <input type="email" id="regEmail" class="form-control mb-3" placeholder="Email">
                    <div id="staffOnly" style="display:none;"><select id="regRole" class="form-select mb-3"><option value="teacher">Teacher</option><option value="account_office">Account Office</option></select></div>
                    <div id="parentOnly" style="display:none;"><input type="text" id="regAdm" class="form-control mb-3" placeholder="Admission Number"></div>
                    <input type="password" id="regPass" class="form-control mb-1" placeholder="Password">
                    <div class="mb-3 px-1"><small style="color: #666; font-size: 0.75rem;">Must have: 1 Uppercase, 1 Lowercase, 1 Number, 1 Special Char</small></div>
                    <button class="btn btn-success w-100" onclick="handleRegister()">Register Account</button>
                    <button class="btn btn-link w-100 mt-2" onclick="toggleView('login')">Back to Login</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentRole = 'admin'; let pendingUserId = null;

        window.onload = function() {
            const p = new URLSearchParams(window.location.search);
            // ONLY show success if it's actually verified
            if (p.get('status') === 'verified') {
                document.getElementById('globalSuccess').style.display = 'block';
                prepAuth(p.get('role') || 'parent');
            } else {
                document.getElementById('globalSuccess').style.display = 'none';
            }
        };

        function clearMessages() {
            document.getElementById('loginAlert').style.display = 'none';
            document.getElementById('registerAlert').style.display = 'none';
            document.getElementById('globalSuccess').style.display = 'none';
        }

        function showHome() {
            clearMessages();
            document.getElementById('homeSection').style.display = 'block';
            document.getElementById('authSection').style.display = 'none';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('link-home').classList.add('active');
        }

        function prepAuth(role) {
            clearMessages(); // Ensure the "Verified" text disappears when switching roles
            currentRole = role;
            document.getElementById('homeSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('link-' + role).classList.add('active');
            document.getElementById('portalTitle').innerText = role.charAt(0).toUpperCase() + role.slice(1) + " Portal";
            toggleView('login');
            
            let inputs = (role === 'parent' || role === 'staff') ? 
                `<input type="text" id="logUser" class="form-control mb-3" placeholder="Username or Email">` :
                `<input type="email" id="logEmail" class="form-control mb-3" placeholder="Admin Email">`;
            
            if (role === 'parent') {
                inputs += `<input type="text" id="logAdm" class="form-control mb-3" placeholder="Admission Number">`;
            }
            inputs += `<input type="password" id="logPass" class="form-control mb-3" placeholder="Password">`;
            document.getElementById('loginInputs').innerHTML = inputs;
            document.getElementById('regHint').style.display = (role === 'admin') ? 'none' : 'block';
        }

        function toggleView(v) {
            document.getElementById('loginView').style.display = (v === 'login') ? 'block' : 'none';
            document.getElementById('registerView').style.display = (v === 'register') ? 'block' : 'none';
            document.getElementById('loginFormContent').style.display = 'block'; 
            document.getElementById('loginOtpForm').style.display = 'none';
        }

        function showRegister() { 
            clearMessages();
            toggleView('register'); 
            document.getElementById('staffOnly').style.display = (currentRole === 'staff') ? 'block' : 'none'; 
            document.getElementById('parentOnly').style.display = (currentRole === 'parent') ? 'block' : 'none'; 
        }

        function showMessage(id, msg, type) { const el = document.getElementById(id); el.textContent = msg; el.className = 'alert-box ' + type; el.style.display = 'block'; }

        async function handleRegister() {
            const pass = document.getElementById('regPass').value;
            const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            if (!regex.test(pass)) { showMessage('registerAlert', 'Password too weak!', 'error'); return; }
            
            const res = await fetch('/api/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username: document.getElementById('regUser').value, email: document.getElementById('regEmail').value, password: pass, user_type: currentRole, staff_role: document.getElementById('regRole')?.value, admission_number: document.getElementById('regAdm')?.value }) });
            const d = await res.json();
            if(d.success) { 
                showMessage('registerAlert', d.message, 'info'); 
                document.getElementById('registerContent').style.display = 'none'; 
            }
            else showMessage('registerAlert', d.message, 'error');
        }

        async function handleLogin() {
            const payload = {
                email: document.getElementById('logEmail')?.value || document.getElementById('logUser')?.value,
                username: document.getElementById('logUser')?.value,
                admission_number: document.getElementById('logAdm')?.value,
                password: document.getElementById('logPass').value,
                user_type: currentRole
            };
            const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const d = await res.json();
            if(d.success) {
                if (d.flow === 'otp_required') { pendingUserId = d.userId; document.getElementById('loginFormContent').style.display = 'none'; document.getElementById('loginOtpForm').style.display = 'block'; showMessage('loginAlert', d.message, 'info'); }
                else finishLogin(d.user.user_type);
            } else showMessage('loginAlert', d.message, 'error');
        }

        async function handleLoginOtp() {
            const res = await fetch('/api/verify-login-otp', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: pendingUserId, otp: document.getElementById('loginOtpInput').value }) });
            const d = await res.json(); if (d.success) finishLogin(d.user.user_type); else showMessage('loginAlert', d.message, 'error');
        }

        function finishLogin(role) { showMessage('loginAlert', 'Success!', 'success'); setTimeout(() => window.location.href = `${role}_dashboard.html`, 1000); }
    </script>
</body>
</html>
